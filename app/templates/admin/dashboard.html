<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
  


{% include 'navbar.html' %}






{% if current_user.is_authenticated and current_user.role == 'admin' %}
  <div class="mb-3">
    <a href="{{ url_for('admin.user_analytics') }}" class="btn btn-outline-info ms-2">ğŸ“Š My Analytics</a>
    <a href="{{ url_for('admin.admin_panel') }}" class="btn btn-outline-dark ms-2">ğŸ› ï¸ Admin Panel</a>
    <a href="{{ url_for('admin.leaderboard') }}" class="btn btn-outline-warning ms-2">ğŸ† Leaderboard</a>
    <a href="{{ url_for('admin.emoji_chart') }}" class="btn btn-outline-primary ms-2">ğŸ“Š Emoji Chart</a>
    <a href="{{ url_for('admin.inactive_users') }}" class="btn btn-outline-danger ms-2">ğŸ’¤ Inactive Users</a>
    
  </div>
{% else %}
  <p class="text-muted">Admin tools are not available for your account.</p>
{% endif %}





  <div class="container py-5">
    <h2 class="mb-4">Welcome, {{ current_user.username }} ğŸ‘‹</h2>



  <form method="GET" class="row g-3 mb-4">
  <select name="crime_type" class="form-select">
  <option value="" {% if not selected_type %}selected{% endif %}>All</option>
  {% for ct in crime_types %}
    <option value="{{ ct }}" {% if selected_type == ct %}selected{% endif %}>{{ ct }}</option>
  {% endfor %}
</select>

<select name="year" class="form-select">
  <option value="" {% if not selected_year %}selected{% endif %}>All</option>
  {% for y in years %}
    <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>{{ y }}</option>
  {% endfor %}
</select>

<select name="region" class="form-select">
  <option value="" {% if not selected_region %}selected{% endif %}>All</option>
  {% for r in regions %}
    <option value="{{ r }}" {% if selected_region == r %}selected{% endif %}>{{ r }}</option>
  {% endfor %}
</select>

  <div class="col-12 text-end">
    <button type="submit" class="btn btn-primary">Filter</button>
  </div>
  <a href="{{ url_for('home.dashboard') }}" class="btn btn-secondary ms-2">Reset</a>
</form>


{% if selected_type or selected_year or selected_region %}
  <div class="alert alert-info">
    Showing <strong>{{ total_crimes }}</strong> crimes{% if selected_type %} for <strong>{{ selected_type }}</strong>{% endif %}{% if selected_region %} in <strong>{{ selected_region }}</strong>{% endif %}{% if selected_year %} during <strong>{{ selected_year }}</strong>{% endif %}.
  </div>
{% endif %}


{% if crime_counts %}
  {% for crime, count in crime_counts.items() %}
    <li>{{ crime }}: {{ count }}</li>
  {% endfor %}
{% else %}
  <p>No crime data available.</p>
{% endif %}

    <!-- Crime Stats -->
  <button class="btn btn-outline-info mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#statsSection" aria-expanded="true" aria-controls="statsSection">
ğŸ“Š Toggle Crime Stats
  </button>
    <div class="collapse show" id="statsSection">
  <div class="row mb-5">
    <!-- Total Crimes -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Total Crimes</h5>
          <p class="display-6">{{ total_crimes }}</p>
        </div>
      </div>
    </div>

    <!-- Crimes by Type -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Crimes by Type</h5>
          <ul class="list-group list-group-flush">
            {% for crime, count in crime_counts.items() %}
              <li class="list-group-item d-flex justify-content-between">
                {{ crime }} <span class="badge bg-primary rounded-pill">{{ count }}</span>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <!-- Crimes by Year -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Crimes by Year</h5>
          <ul class="list-group list-group-flush">
            {% for year, count in year_counts.items() %}
              <li class="list-group-item d-flex justify-content-between">
                {{ year }} <span class="badge bg-secondary rounded-pill">{{ count }}</span>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="container my-5">
  <h4 class="mb-3">Crimes by Type</h4>
  <canvas id="crimeTypeChart"></canvas>
</div>

<script>
const crimeTypeCtx = document.getElementById('crimeTypeChart').getContext('2d');
const crimeTypeChart = new Chart(crimeTypeCtx, {
  type: 'bar',
  data: {
    labels: {{ crime_counts.keys()|list|tojson }},
    datasets: [{
      label: 'Number of Crimes',
      data: {{ crime_counts.values()|list|tojson }},
      backgroundColor: 'rgba(13, 110, 253, 0.6)',
      borderColor: 'rgba(13, 110, 253, 1)',
      borderWidth: 1
    }]
  },
  options: {
    plugins: {
      tooltip: {
        enabled: true,
        callbacks: {
          label: function(context) {
            return `${context.label}: ${context.raw} crimes`;
          }
        }
      }
    },
    scales: {
      y: { beginAtZero: true }
    }
  }
});
</script>



<div class="container my-5">
  <h4 class="mb-3">Crimes by Year</h4>
  <canvas id="crimeYearChart"></canvas>
</div>

<script>
const crimeYearCtx = document.getElementById('crimeYearChart').getContext('2d');
const crimeYearChart = new Chart(crimeYearCtx, {
  type: 'line',
  data: {
    labels: {{ year_counts.keys()|list|tojson }},

    datasets: [{
      label: 'Crimes per Year',
      data: {{ year_counts.values()|list|tojson }},

      fill: false,
      borderColor: 'rgba(255, 99, 132, 1)',
      tension: 0.1
    }]
  },
  options: {
    responsive: true,
    scales: {
      y: { beginAtZero: true }
    }
  }
});
</script>




    <!-- Blog Posts -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>Your Blog Posts</h4>
    </div>





<p>Logged in as: {{ current_user.username }} | Role: {{ current_user.role }}</p>

{% for row in posts %}
  {% set post = row[0] %}
{% set comment_count = row[1] %}

  <div class="card mb-3 shadow-sm">
    <div class="card-body">
      <h5 class="card-title">{{ post.title }}</h5>
      <h6 class="card-subtitle mb-2 text-muted">{{ post.timestamp.strftime('%Y-%m-%d %H:%M') }}</h6>
      <p class="card-text">{{ post.content[:150] }}...</p>

      <p class="text-muted small">
        ğŸ‘ï¸ Views: {{ post.views }} |
        ğŸ’¬ Comments: {{ comment_count }} |
        ğŸ‘ Likes: {{ post.likes }}
      </p>

      <!-- Reaction Form -->
    <form method="POST" action="{{ url_for('home.react') }}">
      <input type="hidden" name="post_id" value="{{ post.id }}">
      {% for emoji in ['ğŸ‘', 'ğŸ˜‚', 'â¤ï¸', 'ğŸ˜¢', 'ğŸ˜¡'] %}
        <button type="submit" name="emoji" value="{{ emoji }}" class="btn btn-sm btn-light me-1">
           {{ post.reactions | selectattr('emoji', 'equalto', 'â¤ï¸') | list | length }}
        </button>
      {% endfor %}
    </form>

      <a href="{{ url_for('home.show_post', post_id=post.id) }}" class="btn btn-sm btn-outline-primary me-2">View</a>
      <a href="{{ url_for('home.edit_post', post_id=post.id) }}" class="btn btn-sm btn-outline-warning me-2">Edit</a>
      <form method="POST" action="{{ url_for('home.delete_post', post_id=post.id) }}" style="display:inline;" onsubmit="return confirm('Delete this post?');">
        <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
      </form>
    </div>
  </div>


<div class="card-body">
  <h5 class="card-title">{{ post.title }}</h5>
  <p class="card-text">{{ post.content[:200] }}...</p>

  {% if post.summary %}
    <div class="alert alert-info mt-2">
      <strong>AI Summary:</strong> {{ post.summary }}
    </div>
  {% endif %}
  <a href="{{ url_for('home.view_post', post_id=post.id) }}" class="btn btn-primary">Read More</a>
</div>
{% endfor %}

  </div>

  <!-- Footer -->
  <footer class="bg-dark text-white text-center py-3 mt-5">
    <p class="mb-0">Â© {{ current_year }} UK Crime Blog. Built by Hassan.</p>
  </footer>
</body>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


</html>